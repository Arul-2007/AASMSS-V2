

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AASMS Student Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>/* ================== RESET & BASE ================== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
}
body {
  background: #f4f6fb;
  color: #333;
  line-height: 1.5;
}

/* ================== LOGIN SECTION ================== */
#loginSection {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #0f9b8e 100%);




}

.login-box {
  background: #b4d9db;
  padding: 40px 30px;
  border-radius: 12px;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 400px;
  text-align: center;
}

.login-box h1 {
  color: #4e54c8;
  margin-bottom: 25px;
  font-size: 1.8rem;
  font-weight: 700;
}

.login-box label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #555;
  font-size: 0.9rem;
}

.login-box input {
  width: 100%;
  padding: 12px 15px;
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 0.95rem;
  transition: 0.3s;
}

.login-box input:focus {
  border-color: #4e54c8;
  box-shadow: 0 0 5px rgba(78, 84, 200, 0.4);
  outline: none;
}

.login-box button {
  width: 100%;
  padding: 12px;
  background: #4e54c8;
  color: #fff;
  border: none;
  font-weight: 600;
  font-size: 1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}

.login-box button:hover {
  background: #3b3fc1;
}

#status {
  margin-top: 10px;
  font-size: 0.85rem;
}

/* ================== DASHBOARD HEADER ================== */
header {
  background: #4e54c8;
  color: #ffffff;
  padding: 0.8rem 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  font-size: 1.15rem;
  position: fixed;
  top: 0;
  width: 100%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  z-index: 10;
}

header button {
  background: #fff;
  color: #4e54c8;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}

header button:hover {
  background: #e6e6ff;
}

/* ================== MAIN CONTENT ================== */
main {
  padding: 100px 20px 90px;
}

/* ================== TABS ================== */
.tab {
  display: none;
  animation: fadeIn 0.4s ease-in-out;
}
.tab.active {
  display: block;
}

.tab-nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: #6a68e6;
  border-top: 1px solid #ddd;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  z-index: 10;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
}

.tab-nav button {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #555;
  font-size: 0.85rem;
  background: none;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

.tab-nav button span {
  font-size: 0.7rem;
}

.tab-nav button.active {
  color: #4e54c8;
}

/* ================== QR SCANNER ================== */
#reader {
  width: 90%;
  max-width: 400px;
  aspect-ratio: 1 / 1;
  margin: 20px auto;
  border-radius: 15px;
  border: 3px solid #4e54c8;
  background: #f9f9f9;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

@media (max-width: 600px) {
  #reader {
    width: 95%;
    max-width: 95%;
    aspect-ratio: 1 / 1;
    border-width: 2px;
  }
}

/* ================== FEEDBACK & TOAST ================== */
#feedback {
  text-align: center;
  font-weight: 600;
  margin-top: 12px;
  color: #4e54c8;
}

#toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #4e54c8;
  color: #fff;
  padding: 14px 22px;
  border-radius: 10px;
  display: none;
  font-weight: bold;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  z-index: 9999;
}

/* ================== TABLE ================== */
.table-container {
  overflow-x: auto;
  margin-top: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

th, td {
  padding: 12px 8px;
  text-align: center;
  border-bottom: 1px solid #eee;
  font-size: 0.85rem;
}

th {
  background: #4e54c8;
  color: #fff;
  font-weight: 600;
}

td.present {
  background: #c8e6c9;
  color: #2e7d32;
  font-weight: 600;
}

td.late {
  background: #ffe0b2;
  color: #ef6c00;
  font-weight: 600;
}

td.absent {
  background: #ffcdd2;
  color: #c62828;
  font-weight: 600;
}

td.notmarked {
  background: #f5f5f5;
  color: #888;
  font-style: italic;
}
/* üéØ Toast styling */
#toastGuide {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #222;
  color: #fff;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 15px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
  z-index: 9999;
}

/* ‚ú® Arrow pointer animation */
#scannerArrow {
  position: fixed;
  bottom: 100px;
  right: 50px;
  font-size: 28px;
  color: #ffcc00;
  opacity: 0;
  transform: translateY(10px);
  animation: bounceArrow 1.2s infinite ease-in-out;
  z-index: 9999;
}

@keyframes bounceArrow {
  0%, 100% { transform: translateY(5px); }
  50% { transform: translateY(-5px); }
}
/* Arrow pointer in bottom-left corner */
#scannerArrow {
  position: fixed;
  bottom: 20px;   /* distance from bottom */
  left: 20px;     /* distance from left */
  font-size: 28px;
  color: #ffcc00;
  opacity: 0;
  transform: translateY(10px);
  animation: bounceArrow 1.2s infinite ease-in-out;
  z-index: 9999;
}

@keyframes bounceArrow {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}


/* ================== ANIMATION ================== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
style.textContent{
@keyframes tabClick {
  0% { transform: scale(0.95); }
  100% { transform: scale(1); }
};}
/* ================== RESPONSIVE ================== */

@media (min-width: 601px) and (max-width: 900px) {
  #reader { height: 300px; }
}
#dashboardSection {
  display: none; /* Hide dashboard by default */
}

#loginSection {
  display: flex; /* Show only login page initially */
}
#loginSection, #dashboardSection {
  transition: opacity 0.3s ease;
  opacity: 1;
}
/* ================== TAB NAVIGATION (Upgraded Glow Version) ================== */
.tab-nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(255, 255, 255, 0.3);
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  z-index: 10;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

/* Tab buttons */
.tab-nav button {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #555;
  font-size: 0.85rem;
  background: none;
  border: none;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
  border-radius: 14px;
  margin: 6px;
  padding: 6px 0;
}

/* Text and icons */
.tab-nav button span {
  font-size: 0.7rem;
}

/* Active Tab ‚Äì Glow Effect */
.tab-nav button.active {
  color: #fff;
  background: linear-gradient(135deg, rgba(78, 84, 200, 0.8), rgba(0, 180, 255, 0.8));
  box-shadow: 0 0 20px rgba(78, 84, 200, 0.6);
  transform: translateY(-3px);
}

/* Smooth glow animation */
.tab-nav button.active::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 14px;
  box-shadow: 0 0 25px rgba(78, 84, 200, 0.7), 0 0 35px rgba(0, 180, 255, 0.6);
  opacity: 0.8;
  z-index: -1;
  transition: all 0.4s ease-in-out;
  filter: blur(8px);
}

/* Hover for inactive tabs */
.tab-nav button:not(.active):hover {
  background: rgba(78, 84, 200, 0.08);
  color: #4e54c8;
  box-shadow: inset 0 0 10px rgba(78, 84, 200, 0.1);
}

</style>
</head>
<body>
  <!-- Global loading overlay -->
<div id="loadingOverlay" style="
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(255,255,255,0.8); z-index:9999;
  justify-content:center; align-items:center; flex-direction:column;
  font-family:'Inter',sans-serif; color:#4e54c8; font-weight:600;">
  <div class="spinner" style="
    border:4px solid #ddd; border-top:4px solid #4e54c8;
    border-radius:50%; width:40px; height:40px;
    animation:spin 1s linear infinite;"></div>
  <p style="margin-top:12px;">Logging in...</p>
</div>

<style>
@keyframes spin {
  0% {transform:rotate(0deg);}
  100% {transform:rotate(360deg);}
}
/* ================== REFRESH BUTTON ================== */
.refresh-btn {
  background: none;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  transition: all 0.3s ease;
  position: relative;
  color: #00bfff;
  font-size: 30px;

}


/* Hover glow */
.refresh-btn:hover {
    background: rgba(0, 180, 255, 0.15);
  box-shadow: 0 0 10px rgba(0, 200, 255, 0.4);
  transform: scale(1.1);
}

/* Click rotation animation */
.refresh-btn:active i {
  animation: spin 0.6s linear;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
/*the code for the logout button animation*/
.logout-btn {
  background: linear-gradient(135deg, rgba(0,180,255,0.8), rgba(0,120,255,0.8));
  color: white;
  border: none;
  padding: 10px 25px;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: 0 0 12px rgba(0,150,255,0.3);
  backdrop-filter: blur(4px);
}

.logout-btn:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, rgba(0,200,255,1), rgba(0,130,255,1));
  box-shadow: 0 0 18px rgba(0,200,255,0.7);
}

.logout-btn:active {
  transform: scale(0.96);
  box-shadow: 0 0 8px rgba(0,150,255,0.5);
}

</style>


<!-- ‚úÖ Toast -->
<div id="toast">‚úÖ Scan Successful</div>

<!-- ========== LOGIN SECTION ========== -->
<section id="loginSection">
  <div class="login-box">
    <h1>AASMS Login</h1>
    <form id="loginForm">
      <label>Email (must end with @ksrce.ac.in)</label>
      <input type="email" id="email" required />
      <label>Password</label>
      <input type="password" id="password" required />
      <button type="submit">Login</button>
    </form>
    <p id="status"></p>
  </div>
</section>

<!-- ========== DASHBOARD SECTION ========== -->
<section id="dashboardSection">
 <header>
  üìò <span id="studentName">Student Dashboard</span>
  <div style="display:flex; gap:8px; align-items:center;">
    <button id="refreshBtn" class="refresh-btn" onclick="refreshPage()">
  <i class="fa-solid fa-rotate-right"></i>
</button>


  <button class="logout-btn" onclick="logout()">Logout</button>

  </div>
</header>


  <main>
    <!-- Scanner Tab -->
    <div id="scannerTab" class="tab active">
      <h3 style="text-align:center;">Scan QR to Mark Attendance</h3>
      <div id="reader"></div>
    

      <div id="feedback">Waiting for scan...</div>
     

     

    </div>

    <!-- Attendance Tab -->
    <div id="attendanceTab" class="tab">
      <h3 style="text-align:center;">Today‚Äôs Attendance</h3>
      <div class="table-container">
        <table id="attendanceTable">
          <thead>
            <tr><th>Period</th><th>Time</th><th>Type</th><th>Status</th></tr>
          </thead>
          <tbody>
  <tr data-period="1"><td>1</td><td>9:00 ‚Äì 9:50</td><td>-</td><td class="absent">Absent</td></tr>
  <tr data-period="2"><td>2</td><td>9:50 ‚Äì 10:40</td><td>-</td><td class="absent">Absent</td></tr>
  <tr data-period="3"><td>3</td><td>10:55 ‚Äì 11:45</td><td>-</td><td class="absent">Absent</td></tr>
  <tr data-period="4"><td>4</td><td>11:45 ‚Äì 12:35</td><td>-</td><td class="absent">Absent</td></tr>
  <tr data-period="5"><td>5</td><td>1:30 ‚Äì 2:20</td><td>-</td><td class="absent">Absent</td></tr>
  <tr data-period="6"><td>6</td><td>2:20 ‚Äì 3:10</td><td>-</td><td class="absent">Absent</td></tr>
  <tr data-period="7"><td>7</td><td>3:10 ‚Äì 4:00</td><td>-</td><td class="absent">Absent</td></tr>
  <tr data-period="8"><td>8</td><td>4:00 ‚Äì 4:50</td><td>-</td><td class="absent">Absent</td></tr>
</tbody>


        </table>
      </div>
    </div>

    <!-- Timetable Tab -->
    <div id="timetableTab" class="tab">
      <h3 style="text-align:center;">Timetable</h3>
      <div class="table-container">
        <table>
          <thead><tr><th>Period</th><th>Time</th><th>Subject</th></tr></thead>
          <tbody id="timetableBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div class="tab-nav">
    <button onclick="openTab('scannerTab', this)" class="tab-content active">üì∑<span>Scanner</span></button>
    <button onclick="openTab('attendanceTab', this)"class="tab-content">üìä<span>Attendance</span></button>
    <button onclick="openTab('timetableTab', this)"class="tab-content">üìÖ<span>Timetable</span></button>
  </div>
</section>
<script>
  let onScanSuccess;
let onScanFailure;

  // ================= Firebase ==================
const firebaseConfig = {
    apiKey: "AIzaSyB8T7Y692ytTeHlfdAPQ9fOvZ3e2qEPTKs",
  authDomain: "aasms-6a83a.firebaseapp.com",
  projectId: "aasms-6a83a",
  storageBucket: "aasms-6a83a.firebasestorage.app",
  messagingSenderId: "475962750818",
  appId: "1:475962750818:web:53b5064c18c7f1e56f1e3b",
  measurementId: "G-4Y58R6KR35"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const loginSection = document.getElementById("loginSection");
  const dashboardSection = document.getElementById("dashboardSection");
  const statusEl = document.getElementById("status");

  // ================= LOGIN (Firestore only) ==================
  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!email.endsWith("@ksrce.ac.in")) {
      statusEl.textContent = "‚ùå Only @ksrce.ac.in emails are allowed";
      statusEl.style.color = "red";
      return;
    }

    try {
      const snapshot = await db.collection("students")
        .where("email", "==", email)
        .limit(1)
        .get();

      if (snapshot.empty) {
        statusEl.textContent = "‚ùå No student found with this email";
        statusEl.style.color = "red";
        return;
      }

      const doc = snapshot.docs[0];
      const student = doc.data();

      if (student.password === password) {
        statusEl.textContent = "";
document.getElementById("loadingOverlay").style.display = "flex";
        statusEl.style.color = "blue";
        localStorage.setItem("studentId", doc.id);
        localStorage.setItem("isLoggedIn", "true");
     
       
  // smooth fade
  
  setTimeout(() => {
  document.getElementById("loadingOverlay").style.display = "none";
  loginSection.style.display = "none";
  dashboardSection.style.display = "block";
  initDashboard(doc.id, student);
  dashboardSection.style.opacity = 0;
dashboardSection.style.display = "block";
requestAnimationFrame(() => {
  dashboardSection.style.opacity = 1;
  openTab('attendanceTab', document.querySelector('[onclick="openTab(\'attendanceTab\', this)"]'));
showLoginGuide(); 

});

}, 300);


      } else {
        statusEl.textContent = "‚ùå Incorrect password";
        statusEl.style.color = "red";
      }
    } catch (err) {
      statusEl.textContent = "‚ùå Error: " + err.message;
      statusEl.style.color = "red";
    }
  });

 
  // ================= Period Timings ==================
  const periods = [
    { start: "09:00", end: "09:50" },
    { start: "09:50", end: "10:40" },
    { start: "10:55", end: "11:45" },
    { start: "11:45", end: "12:35" },
    { start: "13:30", end: "14:20" },
    { start: "14:20", end: "15:10" },
    { start: "15:10", end: "16:00" },
    { start: "16:00", end: "16:50" }
  ];

  function getPeriodIndex(now) {
    const current = now.getHours() * 60 + now.getMinutes();
    for (let i = 0; i < periods.length; i++) {
      const [sh, sm] = periods[i].start.split(":").map(Number);
      const [eh, em] = periods[i].end.split(":").map(Number);
      const startMin = sh * 60 + sm, endMin = eh * 60 + em;
      if (current >= startMin && current <= endMin) return i;
    }
    return -1;
  }

  function getStatus(periodIndex, now) {
    const [sh, sm] = periods[periodIndex].start.split(":").map(Number);
    const startTime = new Date();
    startTime.setHours(sh, sm, 0, 0);
    const diffMinutes = (now - startTime) / 60000;
    if (diffMinutes <= 10) return "Present";
    if (diffMinutes > 10 && diffMinutes <= 50) return "Late";
    return "Absent";
  }

  async function markAttendance(studentId, periodIndex, status, now, type) {
    const today = new Date().toISOString().split("T")[0];
 const ref = db.collection("attendance").doc(studentId).collection(today).doc(`period${periodIndex + 1}`);


    // ‚úÖ Prevent double scan
    const existing = await ref.get();
    if (existing.exists) {
      document.getElementById("feedback").textContent = "‚ö† Already marked for this period!";
      return;
    }

    await ref.set({
      date: today, period: periodIndex + 1, type: type,
      status: status, timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

   const row = document.querySelector(`#attendanceTable tbody tr[data-period="${periodIndex + 1}"]`);
    if (row) {
      row.cells[2].textContent = type;
      row.cells[3].textContent = status;
      row.cells[3].className = status.toLowerCase();
    }

    // ‚úÖ Show toast
   showNotification(`‚úÖ Attendance marked for Period ${periodIndex + 1} (${type})`, "success");

  document.getElementById("feedback").textContent = `‚úÖ ${status} recorded for Period ${periodIndex + 1}`;
}
  // ================== QR SCANNER CONTROL ==================
  let html5QrCode;
  let scanning = false;

  async function startScanner(onScanSuccess, onScanFailure) {
  const feedback = document.getElementById("feedback");
  document.getElementById("reader");
  reader.innerHTML = "";

  // Check if we already have camera permission
  const devices = navigator.mediaDevices;
  let permissionGranted = false;

  try {
    const permissions = await navigator.permissions.query({ name: "camera" });
    if (permissions.state === "granted") {
      permissionGranted = true;
    } else if (permissions.state === "prompt") {
      // Ask the user once
      try {
        await devices.getUserMedia({ video: true });
        permissionGranted = true;
      } catch {
        permissionGranted = false;
      }
    }

    // If denied previously ‚Üí keep asking politely until allowed
    while (!permissionGranted) {
      feedback.textContent = "‚ö†Ô∏è Please allow camera access to start scanning.";
      try {
        await devices.getUserMedia({ video: true });
        permissionGranted = true;
      } catch {
        // Wait 3 seconds before trying again
        await new Promise(resolve => setTimeout(resolve, 3000));
      }
    }

    // ‚úÖ Once permission granted ‚Üí start QR scanner
    html5QrCode = new Html5Qrcode("reader");
    const cameras = await Html5Qrcode.getCameras();

    if (!cameras || cameras.length === 0) {
      feedback.textContent = "‚ùå No camera devices found.";
      return;
    }

    const backCamera = cameras.find(cam => /back|rear|environment/i.test(cam.label));
    const cameraId = backCamera ? backCamera.id : cameras[0].id;

   // ‚úÖ Responsive QR box size
const qrBoxSize = Math.min(window.innerWidth * 0.6, 300);

await html5QrCode.start(
  cameraId,
  {
    fps: 60,
    aspectRatio: 1.0, // keeps it square
        rememberLastUsedCamera: true,
    qrbox: { width: qrBoxSize, height: qrBoxSize },
  },
  decodedText => onScanSuccess(decodedText),
  onScanFailure
);


    scanning = true;
    feedback.textContent = "üì∏ Scanner ready. Align the QR code inside the box.";
  } catch (error) {
    feedback.textContent = "‚ùå Camera initialization failed: " + error.message;
  }
}


  // ‚úÖ Pause camera when tab is hidden or minimized
  document.addEventListener("visibilitychange", () => {
    if (document.hidden && scanning && html5QrCode) {
      html5QrCode.stop().then(() => {
        scanning = false;
        console.log("Camera stopped because tab is hidden");
      }).catch(err => console.error("Stop failed", err));
    }
  });


// ================== DASHBOARD ==================
async function initDashboard(studentId, student) {
  // ================= TIMETABLE =================
  document.getElementById("studentName").textContent = student.name
  ? `${student.name} - Dashboard`
  : "Student Dashboard";


if (student.timetable) {
  const tbody = document.getElementById("timetableBody");
  tbody.innerHTML = "";

  const todayName = new Date().toLocaleDateString("en-US", { weekday: "long" });
  const todaySchedule = student.timetable[todayName];

  if (!todaySchedule || Object.keys(todaySchedule).length === 0) {
    // ‚úÖ If no timetable, show placeholder row
    tbody.innerHTML = `
      <tr>
        <td colspan="3" style="text-align:center; font-style:italic; color:#888;">
          No timetable available today
        </td>
      </tr>`;
  } else {
    // Sort periods like period1, period2, ...
    const sortedPeriods = Object.keys(todaySchedule).sort((a, b) => {
      const numA = parseInt(a.replace(/\D/g, "")); // extract number
      const numB = parseInt(b.replace(/\D/g, ""));
      return numA - numB;
    });

    sortedPeriods.forEach((p, i) => {
      const row = todaySchedule[p];
      tbody.innerHTML += `
        <tr data-period="${i + 1}">
          <td>${i + 1}</td>
          <td>${periods[i].start} ‚Äì ${periods[i].end}</td>
          <td>${row.subject}</td>
        </tr>`;
    });
  }
}


  // ================= ATTENDANCE TABLE =================
  // ================= ATTENDANCE TABLE (FIXED) =================
const atBody = document.querySelector("#attendanceTable tbody");
atBody.innerHTML = "";

// Always get fresh today's date
const now = new Date();
const today = now.toISOString().split("T")[0];
console.log("üìÖ Loading attendance for:", today);

// Fetch attendance from Firestore with cache disabled
const attendanceRef = db.collection("attendance").doc(studentId).collection(today);

try {
  const snapshot = await attendanceRef.get({ source: "server" }); // force server data
  atBody.innerHTML = "";

  for (let i = 0; i < periods.length; i++) {
    const doc = snapshot.docs.find(d => d.id === `period${i + 1}`);
    const data = doc ? doc.data() : null;
    atBody.innerHTML += `
      <tr data-period="${i + 1}">
        <td>${i + 1}</td>
        <td>${periods[i].start} ‚Äì ${periods[i].end}</td>
        <td>${data ? data.type : '-'}</td>
        <td class="${data ? data.status.toLowerCase() : 'absent'}">
          ${data ? data.status : 'Absent'}
        </td>
      </tr>`;
  }

  // ‚úÖ Clear any existing listener to avoid old data mixing
  if (window.attendanceUnsub) window.attendanceUnsub();

  // ‚úÖ Real-time updates for today's date
  window.attendanceUnsub = attendanceRef.onSnapshot(snapshot => {
    const rows = document.querySelectorAll("#attendanceTable tbody tr");
    snapshot.forEach(doc => {
      const data = doc.data();
      const periodIndex = data.period - 1;
      const row = rows[periodIndex];
      if (row) {
        row.cells[2].textContent = data.type || "-";
        row.cells[3].textContent = data.status || "Absent";
        row.cells[3].className = (data.status || "absent").toLowerCase();
      }
    });
  });
} catch (error) {
  console.error("‚ö†Ô∏è Failed to load today's attendance:", error);
  atBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Failed to load attendance</td></tr>`;
}


  // ================= REAL-TIME UPDATES =================
  attendanceRef.onSnapshot(snapshot => {
    const rows = document.querySelectorAll("#attendanceTable tbody tr");
    snapshot.forEach(doc => {
      const data = doc.data();
      const periodIndex = data.period - 1;
      const row = rows[periodIndex];
      if (row) {
        row.cells[2].textContent = data.type || "-";
        row.cells[3].textContent = data.status || "Absent";
        row.cells[3].className = (data.status || "absent").toLowerCase();
      }
    });
  });

  // QR Scanner init remains same...



  // ================== QR SCANNER CONTROL ==================
  let lastScanTime = 0;
   onScanSuccess=function(decodedText) {
    const now = new Date();
    const currentTime = now.getTime();
    if (currentTime - lastScanTime < 5000) return;
    lastScanTime = currentTime;
    
    feedback.textContent = "‚úÖ Scanned successfully!";
    feedback.style.color = "green";

    const periodIndex = getPeriodIndex(now);
    if (periodIndex === -1) {
      document.getElementById("feedback").textContent = "‚ùå Not within class time!";
      return;
    }

    const text = decodedText.trim().toUpperCase().replace(/\s+/g, "");
    const todayName = now.toLocaleDateString("en-US", { weekday: "long" });
    const todaySchedule = student.timetable[todayName];
    const periodKey = Object.keys(todaySchedule)[periodIndex];
     if (!todaySchedule[periodKey]) {
    document.getElementById("feedback").textContent = "‚ùå No class scheduled!";
    return;
}
    const subject = todaySchedule[periodKey].subject;

    if (text === "NORMALCLASSROOM") {
      markAttendance(studentId, periodIndex, getStatus(periodIndex, now), now, "Normal");

      // Mark consecutive lab periods if any
      if (subject.toLowerCase().includes("lab")) {
        for (let i = periodIndex + 1; i < periods.length; i++) {
          const nextKey = Object.keys(todaySchedule)[i];
          if (todaySchedule[nextKey] && todaySchedule[nextKey].subject === subject) {
            markAttendance(studentId, i, getStatus(i, now), now, "Normal");
          } else break;
        }
      }
    } else if (text === "SKILLCLASSROOM") {
      markAttendance(studentId, periodIndex, getStatus(periodIndex, now), now, "Skill");
    } else {
      document.getElementById("feedback").textContent = "‚ùå Invalid QR Code!";
    }
  }

  onScanFailure=function(err) {
    console.warn("Scan failed:", err);
    document.getElementById("feedback").textContent = "Scanning...";
  };



 
}



  // ================== AUTO LOGIN ==================

  function openTab(tabId, btn) {
  document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
  document.querySelectorAll(".tab-nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  btn.classList.add("active");

  // subtle vibration or glow animation
  btn.style.animation = "tabClick 0.25s ease";
  setTimeout(() => (btn.style.animation = ""), 250);
  // ‚úÖ Auto-start scanner when switching to scanner tab
 if (tabId === "scannerTab" && !scanning) {
  setTimeout(() => startScanner(onScanSuccess, onScanFailure), 500);
}

}
const style = document.createElement("style");

document.head.appendChild(style);
function logout() {
    alert("Logging out...");
    // Stop QR scanner safely
    if (html5QrCode && scanning) {
        html5QrCode.stop().catch(() => {});
        scanning = false;
    }

    // Fade out dashboard
    dashboardSection.style.opacity = 0;

    setTimeout(() => {
        dashboardSection.style.display = "none";
        loginSection.style.display = "flex";
        loginSection.style.opacity = 0;

        // Trigger fade-in animation
        requestAnimationFrame(() => {
            loginSection.style.opacity = 1;
        });

        // Clear student session
        localStorage.removeItem("studentId");
    }, 300);
}

// Auto-login handling
// ‚úÖ AUTO-LOGIN CHECK
window.addEventListener("load", async () => {
  const savedStudentId = localStorage.getItem("studentId");

  if (savedStudentId) {
    try {
      // Ensure Firebase is ready before accessing Firestore
      await new Promise(resolve => setTimeout(resolve, 1000)); // wait 1 sec for safety

      const docRef = db.collection("students").doc(savedStudentId);
      const docSnap = await docRef.get();

      if (docSnap.exists) {
        // Hide login, show dashboard
        loginSection.style.display = "none";
        dashboardSection.style.display = "block";

        // Initialize dashboard UI
initDashboard(savedStudentId, docSnap.data());
openTab('attendanceTab', document.querySelector('[onclick="openTab(\'attendanceTab\', this)"]'));
showLoginGuide(); 

        console.log("‚úÖ Auto-login successful for:", savedStudentId);
      } else {
        // If ID invalid, clear it
        localStorage.removeItem("studentId");
        console.warn("‚ö†Ô∏è Saved student not found, cleared localStorage.");
      }
    } catch (error) {
      console.error("Auto-login error:", error);
    }
  } else {
    console.log("‚ÑπÔ∏è No saved login found ‚Äî staying on login screen.");
  }
});


document.getElementById("refreshButton").addEventListener("click", async () => {
  const studentId = localStorage.getItem("studentId");
  if (!studentId) return;

  const doc = await db.collection("students").doc(studentId).get();
  if (doc.exists) {
    const student = doc.data();
    initDashboard(studentId, student);
    showToast("üîÑ Data refreshed");
  }
});


let inactivityTimer;
function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    showToast("‚è∞ Session expired. Logging out...");
    setTimeout(logout, 2000);
  }, 15 * 60 * 1000); // 15 minutes
}

// Reset timer on any interaction
["click", "mousemove", "keypress", "scroll", "touchstart"].forEach(evt => {
  document.addEventListener(evt, resetInactivityTimer);
});
resetInactivityTimer();
function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 3000);
}


function refreshPage() {
  const icon = document.querySelector("#refreshBtn i");
  icon.style.animation = "spin 0.6s linear";
  setTimeout(() => {
       icon.style.animation = "";
    location.reload(); // Refreshes the page
  }, 600);
}

function showLoginGuide() {
 
 

  toast.style.opacity = 1;
  arrow.style.opacity = 1;

  // Hide after 5 seconds
  setTimeout(() => {
    toast.style.opacity = 0;
    arrow.style.opacity = 0;
  }, 5000);
}

function showNotification(message, type = "info") {
  const toast = document.getElementById("toast");

  // Style based on type
  if (type === "success") {
    toast.style.background = "#4CAF50"; // green
  } else if (type === "warning") {
    toast.style.background = "#FFC107"; // amber
  } else if (type === "error") {
    toast.style.background = "#F44336"; // red
  } else {
    toast.style.background = "#4e54c8"; // default
  }

  toast.textContent = message;
  toast.style.display = "block";
  toast.style.opacity = 1;

  // Fade out after 4s
  setTimeout(() => {
    toast.style.transition = "opacity 0.5s";
    toast.style.opacity = 0;
    setTimeout(() => (toast.style.display = "none"), 500);
  }, 4000);
}

</script>

<div id="scannerArrow">‚¨áÔ∏è</div>
<div id="toastGuide">‚úÖ Login successful!</div>


</body>
</html>
